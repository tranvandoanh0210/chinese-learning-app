<div class="dialogue-exercise">
  @for (exercise of getDialogueExercises(); track $index) {
  <div class="exercise-item">
    <div class="dialogue-card" [class.completed]="isExerciseCompleted(exercise)">
      <div class="status-icon">
        @if (isExerciseCompleted(exercise)) {
        <span class="checkmark">✓</span>
        }
      </div>
      <!-- Dialogue Content - Chat Layout -->
      <div class="dialogue-content chat-layout">
        <div class="chat-messages">
          @for (line of exercise.lines; track $index) {
          <div
            class="message"
            [class.left]="exercise.lines.indexOf(line) % 2 == 0"
            [class.right]="exercise.lines.indexOf(line) % 2 == 1"
          >
            <!-- Speaker A (left side) -->
            @if (exercise.lines.indexOf(line) % 2 == 0) {
            <div class="message-left">
              <div class="message-avatar">
                <div class="avatar">{{ getInitials(line.speaker) }}</div>
              </div>
              <div class="message-content">
                <div class="message-bubble left-bubble">
                  <div class="message-pinyin">{{ line.pinyin }}</div>
                  <div class="message-text">{{ line.text }}</div>
                  <div class="message-meaning">{{ line.translation }}</div>
                </div>
                <button class="audio-btn" (click)="playLineAudio(line.text)" [disabled]="isPlaying">
                  {{ isPlaying ? '🔊...' : '🔊' }}
                </button>
              </div>
            </div>
            }

            <!-- Speaker B (right side) -->
            @if (exercise.lines.indexOf(line) % 2 == 1) {
            <div class="message-right">
              <div class="message-content">
                <div class="message-bubble right-bubble">
                  <div class="message-text">{{ line.text }}</div>
                  <div class="message-pinyin">{{ line.pinyin }}</div>
                </div>
                <button class="audio-btn" (click)="playLineAudio(line.text)" [disabled]="isPlaying">
                  {{ isPlaying ? '🔊...' : '🔊' }}
                </button>
              </div>
              <div class="message-avatar">
                <div class="avatar">{{ getInitials(line.speaker) }}</div>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>

      <!-- Controls -->
      <div class="dialogue-controls">
        <button
          class="btn btn-primary play-all-btn"
          (click)="playAllDialogue(exercise.lines)"
          [disabled]="isPlaying"
        >
          {{ isPlaying ? '🔊 Đang phát...' : '🎭 Nghe toàn bộ hội thoại' }}
        </button>
        @if(!isExerciseCompleted(exercise)){

        <button class="btn-complete" (click)="markAsCompleted(exercise)">
          <span>Đánh dấu đã học</span>
        </button>
        }
      </div>
    </div>
  </div>
  }
</div>
