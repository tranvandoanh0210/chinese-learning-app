<div class="speaking-exercise">
  <!-- Progress Header -->
  <div class="progress-header">
    <div class="progress-info">
      <div class="progress-text">
        CÃ¢u {{ currentIndex + 1 }} / {{ getSpeakingExercises().length }}
      </div>
      <div class="progress-bar">
        <div
          class="progress-fill"
          [style.width.%]="(currentIndex / getSpeakingExercises().length) * 100"
        ></div>
      </div>
    </div>
    <div class="completed-count">
      ÄÃ£ hoÃ n thÃ nh: {{ getCompletedCount() }}/{{ getSpeakingExercises().length }}
    </div>
  </div>

  <!-- Current Exercise -->
  <div class="current-exercise" *ngIf="currentExercise">
    <div class="speaking-card">
      <!-- Question Header -->
      <div class="question-header">
        <h3 class="question-title">Luyá»‡n phÃ¡t Ã¢m</h3>
        <div class="question-text">{{ currentExercise.question }}</div>
        <div class="pinyin">{{ currentExercise.pinyin }}</div>
        <div class="meaning">NghÄ©a: {{ currentExercise.answer }}</div>
      </div>

      <!-- Audio Controls -->
      <div class="audio-controls">
        <button
          class="btn btn-primary"
          (click)="playSampleAudio(currentExercise.question)"
          [disabled]="getCurrentState().isPlaying"
        >
          {{ getCurrentState().isPlaying ? 'ğŸ”Š Äang phÃ¡t...' : 'ğŸ”Š Nghe máº«u' }}
        </button>

        <button
          class="btn btn-secondary"
          (click)="playVietnameseAudio(currentExercise.answer)"
          [disabled]="getCurrentState().isPlaying"
        >
          ğŸ”Š Nghe nghÄ©a
        </button>
      </div>

      <!-- Recording Section -->
      <div class="recording-section" *ngIf="!getCurrentState().isCompleted">
        <div class="recording-controls">
          <button
            class="btn-record"
            [class.recording]="getCurrentState().isRecording"
            [class.success]="getCurrentState().result?.matches"
            [class.error]="getCurrentState().result && !getCurrentState().result?.matches"
            (click)="toggleRecording(currentExercise.question)"
          >
            <div class="mic-icon">
              <span *ngIf="!getCurrentState().isRecording">ğŸ¤</span>
              <span *ngIf="getCurrentState().isRecording" class="pulse">ğŸ”´</span>
            </div>
            <div class="record-text">
              {{ getRecordButtonText() }}
            </div>
          </button>
        </div>

        <!-- User Speech Display -->
        <div *ngIf="getCurrentState().userSpeech" class="user-speech">
          <div class="speech-label">Báº¡n nÃ³i:</div>
          <div class="speech-text">{{ getCurrentState().userSpeech }}</div>
        </div>

        <!-- Pronunciation Result -->
        <div *ngIf="getCurrentState().result" class="pronunciation-result">
          <div class="result-header">
            <div class="accuracy-score">
              Äá»™ chÃ­nh xÃ¡c: {{ getCurrentState().result?.accuracy }}%
            </div>
            <div class="confidence">Äá»™ tin cáº­y: {{ getConfidencePercentage() }}%</div>
          </div>

          <div
            class="feedback"
            [class.success]="getCurrentState().result?.matches"
            [class.error]="getCurrentState().result && !getCurrentState().result?.matches"
          >
            {{ getCurrentState().result?.feedback }}
          </div>

          <div class="result-actions">
            <button class="btn btn-outline" (click)="tryAgain()">ğŸ”„ Thá»­ láº¡i</button>
            <button class="btn btn-success" (click)="completeCurrentExercise()">
              âœ… HoÃ n thÃ nh
            </button>
          </div>
        </div>
      </div>

      <!-- Completed State -->
      <div *ngIf="getCurrentState().isCompleted" class="completed-state">
        <div class="success-message">âœ… ÄÃ£ hoÃ n thÃ nh bÃ i luyá»‡n nÃ³i!</div>
        <div class="completed-actions">
          <button class="btn btn-outline" (click)="tryAgain()">ğŸ”„ Luyá»‡n táº­p láº¡i</button>
          <button *ngIf="!isLastExercise" class="btn btn-primary" (click)="nextExercise()">
            CÃ¢u tiáº¿p theo â†’
          </button>
          <button *ngIf="isLastExercise" class="btn btn-success" (click)="finishAllExercises()">
            ğŸ‰ HoÃ n thÃ nh táº¥t cáº£
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="navigation-controls">
    <button class="btn-nav prev" (click)="previousExercise()" [disabled]="currentIndex === 0">
      â† CÃ¢u trÆ°á»›c
    </button>

    <div class="exercise-dots">
      <span
        *ngFor="let exercise of getSpeakingExercises(); let i = index"
        class="dot"
        [class.active]="i === currentIndex"
        [class.completed]="getSpeakingState(i).isCompleted"
        (click)="goToExercise(i)"
      >
        {{ i + 1 }}
      </span>
    </div>

    <button class="btn-nav next" (click)="nextExercise()" [disabled]="isLastExercise">
      CÃ¢u tiáº¿p theo â†’
    </button>
  </div>

  <!-- All Completed -->
  <div *ngIf="allExercisesCompleted" class="all-completed">
    <div class="completion-card">
      <div class="completion-icon">ğŸ‰</div>
      <h3>ChÃºc má»«ng!</h3>
      <p>Báº¡n Ä‘Ã£ hoÃ n thÃ nh táº¥t cáº£ {{ getSpeakingExercises().length }} bÃ i luyá»‡n nÃ³i</p>
      <div class="completion-stats">
        <div class="stat">
          <div class="stat-value">{{ getCompletedCount() }}</div>
          <div class="stat-label">CÃ¢u Ä‘Ã£ hoÃ n thÃ nh</div>
        </div>
        <div class="stat">
          <div class="stat-value">{{ getSuccessRate() }}%</div>
          <div class="stat-label">Tá»· lá»‡ thÃ nh cÃ´ng</div>
        </div>
      </div>
      <button class="btn btn-primary" (click)="restartAll()">ğŸ”„ LÃ m láº¡i táº¥t cáº£</button>
    </div>
  </div>
</div>
