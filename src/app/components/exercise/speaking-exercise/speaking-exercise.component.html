<div class="speaking-exercise">
  <!-- Current Exercise -->
  @if (currentExercise) {
  <div class="current-exercise">
    <div class="speaking-card" [class.completed]="isExerciseCompleted(currentExercise)">
      <div class="status-icon">
        @if (isExerciseCompleted(currentExercise)) {
        <span class="checkmark">✓</span>
        }
      </div>
      <!-- Question Header -->
      <div class="question-header">
        <div class="question-text">{{ currentExercise.question }}</div>
        <div class="pinyin">{{ currentExercise.pinyin }}</div>
        <div class="meaning">Nghĩa: {{ currentExercise.answer }}</div>
      </div>

      <!-- Audio Controls -->
      <div class="audio-controls">
        <button
          class="btn btn-primary"
          (click)="playSampleAudio(currentExercise.question)"
          [disabled]="getCurrentState().isPlaying"
        >
          {{ getCurrentState().isPlaying ? '🔊 Đang phát...' : '🔊 Nghe mẫu' }}
        </button>

        <button
          class="btn btn-secondary"
          (click)="playVietnameseAudio(currentExercise.answer)"
          [disabled]="getCurrentState().isPlaying"
        >
          🔊 Nghe nghĩa
        </button>
      </div>

      <!-- Recording Section -->
      @if (!getCurrentState().isCompleted) {
      <div class="recording-section">
        <div class="recording-controls">
          <button
            class="btn-record"
            [class.recording]="getCurrentState().isRecording"
            [class.success]="getCurrentState().result?.matches"
            [class.error]="getCurrentState().result && !getCurrentState().result?.matches"
            (click)="toggleRecording(currentExercise.pinyin)"
          >
            <div class="mic-icon">
              @if (!getCurrentState().isRecording) {
              <span>🎤</span>
              } @if (getCurrentState().isRecording) {
              <span class="pulse">🔴</span>
              }
            </div>
            <div class="record-text">
              {{ getRecordButtonText() }}
            </div>
          </button>
        </div>

        <!-- User Speech Display -->
        @if (getCurrentState().userSpeech) {
        <div class="user-speech">
          <div class="speech-label">Bạn nói:</div>
          <div class="speech-text">{{ getCurrentState().userSpeech }}</div>
        </div>
        }

        <!-- Pronunciation Result -->
        @if (getCurrentState().result) {
        <div class="pronunciation-result">
          <div class="result-header">
            <div class="accuracy-score">
              Độ chính xác: {{ getCurrentState().result?.accuracy }}%
            </div>
          </div>

          <div
            class="feedback"
            [class.success]="getCurrentState().result?.matches"
            [class.error]="getCurrentState().result && !getCurrentState().result?.matches"
          >
            {{ getCurrentState().result?.feedback }}
          </div>

          <!-- <div class="result-actions">
            <button class="btn btn-outline" (click)="tryAgain()">🔄 Thử lại</button>
          </div> -->
        </div>
        }
      </div>
      }

      <!-- Completed State -->
      @if (getCurrentState().isCompleted) {
      <div class="completed-state">
        <div class="success-message">✅ Đã hoàn thành bài luyện nói!</div>
        <div class="completed-actions">
          <!-- <button class="btn btn-outline" (click)="tryAgain()">🔄 Luyện tập lại</button> -->
          @if (!isLastExercise) {
          <button class="btn btn-primary" (click)="nextExercise()">Câu tiếp theo →</button>
          }
          <!-- @if (isLastExercise) {
          <button class="btn btn-success" (click)="finishAllExercises()">
            🎉 Hoàn thành tất cả
          </button>
          } -->
        </div>
      </div>
      }
    </div>
  </div>
  }

  <!-- Navigation -->
  <div class="navigation-controls">
    <button class="btn-nav prev" (click)="previousExercise()" [disabled]="currentIndex === 0">
      ← Câu trước
    </button>

    <div class="exercise-dots">
      @for (exercise of getSpeakingExercises(); let i = $index; track i) {
      <span
        class="dot"
        [class.active]="i === currentIndex"
        [class.completed]="getSpeakingState(i).isCompleted"
        (click)="goToExercise(i)"
      >
        <div class="completion-badge" *ngIf="currentExercise && isExerciseCompleted(exercise)">
          ✓
        </div>

        {{ i + 1 }}
      </span>
      }
    </div>

    <button class="btn-nav next" (click)="nextExercise()" [disabled]="isLastExercise">
      Câu tiếp theo →
    </button>
  </div>
</div>
@if (showErrorDialog) {
<div class="error-dialog-backdrop">
  <div class="error-dialog">
    <h3>⚠️ Lỗi ghi âm</h3>
    <p class="message">{{ errorMessage }}</p>
    <button class="btn btn-primary" (click)="closeErrorDialog()">Đóng</button>
  </div>
</div>
}
