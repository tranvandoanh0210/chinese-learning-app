<div class="test-exercise">
  <!-- Start Screen -->
  <div *ngIf="!testStarted && !showResults" class="start-screen">
    <div class="start-card">
      <div class="start-icon">üìù</div>
      <h2>B√†i Ki·ªÉm Tra</h2>
      <div class="test-info">
        <div class="info-item">
          <span class="info-label">S·ªë c√¢u:</span>
          <span class="info-value">{{ exercises.length }} c√¢u</span>
        </div>
        <div class="info-item">
          <span class="info-label">Th·ªùi gian:</span>
          <span class="info-value">Kh√¥ng gi·ªõi h·∫°n</span>
        </div>
        <div class="info-item">
          <span class="info-label">Lo·∫°i b√†i:</span>
          <span class="info-value">Tr·∫Øc nghi·ªám & T·ª± lu·∫≠n</span>
        </div>
      </div>
      <button class="btn-start" (click)="startTest()">üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i</button>
    </div>
  </div>

  <!-- Test Interface -->
  <div *ngIf="testStarted && !showResults" class="test-interface">
    <!-- Test Header -->
    <div class="test-header">
      <div class="progress-info">
        <div class="progress-text">C√¢u {{ currentIndex + 1 }} / {{ exercises.length }}</div>
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="(currentIndex / exercises.length) * 100"
          ></div>
        </div>
      </div>
      <div class="timer" [class.warning]="elapsedTime.totalSeconds > 300">
        ‚è±Ô∏è {{ formatTime(elapsedTime) }}
      </div>
    </div>

    <!-- Current Question -->
    <div class="question-container" *ngIf="currentExercise">
      <div class="question-card">
        <div class="question-header">
          <h3 class="question-title">{{ currentExercise.question }}</h3>
          <div *ngIf="currentExercise.description" class="question-description">
            {{ currentExercise.description }}
          </div>
        </div>

        <!-- Multiple Choice -->
        <div *ngIf="isMultipleChoiceExercise(currentExercise)" class="options-container">
          <div
            *ngFor="let option of getMultipleChoiceOptions(currentExercise); let i = index"
            class="option-card"
            [class.selected]="getUserAnswer(currentIndex) === option"
            [class.correct]="showResults && option === currentExercise.answer"
            [class.incorrect]="
              showResults &&
              getUserAnswer(currentIndex) === option &&
              option !== currentExercise.answer
            "
            (click)="selectOption(option)"
          >
            <div class="option-letter">{{ getOptionLetter(i) }}</div>
            <div class="option-text">{{ option }}</div>
            <div *ngIf="showResults && option === currentExercise.answer" class="correct-indicator">
              ‚úì
            </div>
          </div>
        </div>

        <!-- Input Answer -->
        <div *ngIf="isInputExercise(currentExercise)" class="input-container">
          <input
            type="text"
            [placeholder]="getInputPlaceholder(currentExercise)"
            [value]="getUserAnswer(currentIndex) || ''"
            (input)="updateInputAnswer($event)"
            class="answer-input"
            [class.correct]="showResults && isAnswerCorrect(currentIndex)"
            [class.incorrect]="showResults && !isAnswerCorrect(currentIndex)"
          />
        </div>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <button
        class="btn btn-secondary"
        (click)="previousQuestion()"
        [disabled]="currentIndex === 0"
      >
        ‚Üê C√¢u tr∆∞·ªõc
      </button>

      <button *ngIf="!isLastQuestion" class="btn btn-primary" (click)="nextQuestion()">
        C√¢u ti·∫øp theo ‚Üí
      </button>

      <button *ngIf="isLastQuestion" class="btn btn-success" (click)="submitTest()">
        üéØ N·ªôp b√†i
      </button>
    </div>
  </div>

  <!-- Results Summary -->
  <div *ngIf="showResults" class="results-summary">
    <div class="results-card">
      <div class="results-header">
        <h3>üéâ K·∫øt qu·∫£ b√†i ki·ªÉm tra</h3>
        <div class="score">{{ correctCount }}/{{ exercises.length }}</div>
      </div>

      <div class="test-meta">
        <div class="meta-item">
          <span class="meta-label">Th·ªùi gian ho√†n th√†nh:</span>
          <span class="meta-value">{{ formatTime(elapsedTime) }}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">S·ªë c√¢u ƒë√£ l√†m:</span>
          <span class="meta-value">{{ getAnsweredCount() }}/{{ exercises.length }}</span>
        </div>
      </div>

      <div class="score-breakdown">
        <div class="score-item correct">
          <span class="score-label">ƒê√∫ng:</span>
          <span class="score-value">{{ correctCount }}</span>
        </div>
        <div class="score-item incorrect">
          <span class="score-label">Sai:</span>
          <span class="score-value">{{ incorrectCount }}</span>
        </div>
        <div class="score-item percentage">
          <span class="score-label">T·ª∑ l·ªá:</span>
          <span class="score-value">{{ getPercentage() }}%</span>
        </div>
      </div>

      <div class="progress-circle">
        <div class="circle-background"></div>
        <div class="circle-progress"></div>
        <div class="circle-text">
          <span class="percentage">{{ getPercentage() }}%</span>
          <span class="label">ƒêi·ªÉm s·ªë</span>
        </div>
      </div>

      <div class="answers-review">
        <h4>Chi ti·∫øt b√†i l√†m:</h4>
        <div
          *ngFor="let exercise of exercises; let i = index"
          class="answer-item"
          [class.correct]="userAnswers[i]?.isCorrect"
          [class.incorrect]="userAnswers[i] && !userAnswers[i]!.isCorrect"
          [class.unanswered]="!userAnswers[i]"
        >
          <div class="answer-header">
            <div class="question-number">C√¢u {{ i + 1 }}</div>
            <div class="answer-status">
              <span *ngIf="userAnswers[i]?.isCorrect" class="status-correct">‚úì ƒê√∫ng</span>
              <span *ngIf="userAnswers[i] && !userAnswers[i]!.isCorrect" class="status-incorrect"
                >‚úó Sai</span
              >
              <span *ngIf="!userAnswers[i]" class="status-unanswered">‚è∏Ô∏è Ch∆∞a l√†m</span>
            </div>
          </div>
          <div class="answer-question">
            {{ exercise.question }}
          </div>
          <div class="answer-details">
            <div class="detail-item">
              <span class="detail-label">ƒê√°p √°n c·ªßa b·∫°n:</span>
              <span class="detail-value">{{ getUserAnswer(i) || 'Ch∆∞a tr·∫£ l·ªùi' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">ƒê√°p √°n ƒë√∫ng:</span>
              <span class="detail-value correct-answer">{{ exercise.answer }}</span>
            </div>
            <div *ngIf="exercise.explanation" class="detail-item explanation">
              <span class="detail-label">Gi·∫£i th√≠ch:</span>
              <span class="detail-value">{{ exercise.explanation }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="results-actions">
        <button class="btn btn-primary" (click)="restartTest()">üîÑ L√†m l·∫°i t·ª´ ƒë·∫ßu</button>
      </div>
    </div>
  </div>
</div>
