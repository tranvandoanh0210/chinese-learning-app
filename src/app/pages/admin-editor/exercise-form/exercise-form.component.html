<div class="form-container">
  <!-- Form Content -->
  <div class="form-content">
    <div class="form-main">
      <div class="form-card">
        <!-- Basic Information -->
        <div class="form-section">
          <!-- Header -->
          <div class="form-header">
            <div class="header-content">
              <button class="btn-back" (click)="cancel()" title="Quay l·∫°i">‚Üê</button>
              <div>
                <h1>{{ isEditMode ? '‚úèÔ∏è S·ª≠a b√†i t·∫≠p' : '‚ûï Th√™m b√†i t·∫≠p m·ªõi' }}</h1>
                <div class="breadcrumb">
                  @if(lesson){
                  <span
                    >B√†i h·ªçc: <strong>{{ lesson.name_vi }}</strong></span
                  >} @if(category){
                  <span>
                    ‚Üí Danh m·ª•c: <strong>{{ category.name }}</strong></span
                  >}
                </div>
              </div>
            </div>
            <div class="header-actions">
              <button class="btn btn-primary" (click)="saveExercise()" [disabled]="loading">
                @if(loading){ <span class="spinner-small"></span>} üíæ
                {{ isEditMode ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi' }}
              </button>
            </div>
          </div>

          <div class="form-grid">
            @if(canEditExerciseType){
            <div class="form-group">
              <label for="type" class="required">Lo·∫°i b√†i t·∫≠p</label>
              <select
                id="type"
                [(ngModel)]="exercise.type"
                (change)="onTypeChange()"
                [disabled]="loading || isEditMode"
              >
                @for (type of availableExerciseTypes; track $index) {
                <option [value]="type.value">{{ type.icon }} {{ type.label }}</option>
                }
              </select>
            </div>
            } @if(exercise.type !== 'dialogue'){
            <div class="form-group full-width">
              <label for="question" class="required">C√¢u h·ªèi</label>
              <input
                type="text"
                id="question"
                [(ngModel)]="exercise.question"
                placeholder="Nh·∫≠p c√¢u h·ªèi..."
                [disabled]="loading"
              />
            </div>
            } @if(exercise.type !== 'dialogue'){
            <div class="form-group">
              <label for="answer">ƒê√°p √°n</label>
              <input
                type="text"
                id="answer"
                [(ngModel)]="exercise.answer"
                placeholder="Nh·∫≠p ƒë√°p √°n..."
                [disabled]="loading"
              />
            </div>
            }
            <!-- Dynamic Fields Based on Exercise Type -->

            @if( exercise.type === 'vocabulary' || exercise.type === 'flashcard' || exercise.type
            === 'writing' || exercise.type === 'speaking' ){
            <div class="form-group">
              <label for="pinyin">Pinyin</label>
              <input
                type="text"
                id="pinyin"
                [(ngModel)]="formData.pinyin"
                placeholder="Nh·∫≠p pinyin..."
                [disabled]="loading"
              />
            </div>
            }@if(exercise.type === 'grammar'){
            <div class="form-group full-width">
              <div class="form-group">
                <label for="content">N·ªôi dung ng·ªØ ph√°p</label>
                <textarea
                  id="content"
                  [(ngModel)]="formData.content"
                  placeholder="Gi·∫£i th√≠ch ƒëi·ªÉm ng·ªØ ph√°p..."
                  rows="4"
                  [disabled]="loading"
                ></textarea>
              </div>

              <div class="form-group">
                <label>V√≠ d·ª• minh h·ªça</label>
                @for (example of formData.examples; track $index; let i = $index) {
                <div class="array-item">
                  <input
                    type="text"
                    [(ngModel)]="formData.examples[i]"
                    [placeholder]="'V√≠ d·ª• ' + (i + 1) + '...'"
                    [disabled]="loading"
                  />
                  <button
                    type="button"
                    class="btn-icon btn-danger"
                    (click)="removeExample(i)"
                    [disabled]="formData.examples.length === 1"
                  >
                    üóëÔ∏è
                  </button>
                </div>
                }
                <button
                  type="button"
                  class="btn btn-outline"
                  (click)="addExample()"
                  [disabled]="loading"
                >
                  + Th√™m v√≠ d·ª•
                </button>
              </div>
            </div>
            } @if(exercise.type === 'multiple_choice'){
            <div class="form-group full-width">
              <label class="required">C√°c l·ª±a ch·ªçn</label>
              @for ( option of formData.options; track $index; let i = $index) {
              <div class="array-item">
                <input
                  type="text"
                  [(ngModel)]="formData.options[i]"
                  [placeholder]="'L·ª±a ch·ªçn ' + (i + 1) + '...'"
                  [disabled]="loading"
                />
                <button
                  type="button"
                  class="btn-icon btn-danger"
                  (click)="removeOption(i)"
                  [disabled]="formData.options.length === 2"
                >
                  üóëÔ∏è
                </button>
              </div>
              }
              <button
                type="button"
                class="btn btn-outline"
                (click)="addOption()"
                [disabled]="loading"
              >
                + Th√™m l·ª±a ch·ªçn
              </button>
            </div>
            } @if(exercise.type !== 'dialogue'){
            <div class="form-group full-width">
              <label for="explanation">Gi·∫£i th√≠ch</label>
              <textarea
                id="explanation"
                [(ngModel)]="exercise.explanation"
                placeholder="Gi·∫£i th√≠ch ƒë√°p √°n..."
                rows="3"
                [disabled]="loading"
              ></textarea>
            </div>
            } @if(exercise.type === 'input'){
            <div class="form-group">
              <label for="placeholder">Placeholder</label>
              <input
                type="text"
                id="placeholder"
                [(ngModel)]="formData.placeholder"
                placeholder="VƒÉn b·∫£n g·ª£i √Ω..."
                [disabled]="loading"
              />
            </div>
            }
          </div>
        </div>
        @if(exercise.type === 'dialogue'){
        <div class="form-group full-width">
          <div class="form-group">
            <label for="context" class="required">Ng·ªØ c·∫£nh</label>
            <input
              type="text"
              id="context"
              [(ngModel)]="formData.context"
              placeholder="M√¥ t·∫£ ng·ªØ c·∫£nh h·ªôi tho·∫°i..."
              [disabled]="loading"
            />
          </div>

          <div class="form-group">
            <label class="required">C√°c l∆∞·ª£t h·ªôi tho·∫°i</label>
            @for (line of formData.lines; track $index; let i = $index) {
            <div class="dialogue-line">
              <div class="line-header">
                <h4>L∆∞·ª£t {{ i + 1 }}</h4>
                <button
                  type="button"
                  class="btn-icon btn-danger"
                  (click)="removeDialogueLine(i)"
                  [disabled]="formData.lines.length === 1"
                >
                  üóëÔ∏è
                </button>
              </div>

              <div class="line-fields">
                <div class="form-group">
                  <label [for]="'speaker_' + i" class="required">Ng∆∞·ªùi n√≥i</label>
                  <input
                    type="text"
                    [id]="'speaker_' + i"
                    [(ngModel)]="line.speaker"
                    placeholder="T√™n ng∆∞·ªùi n√≥i..."
                    [disabled]="loading"
                  />
                </div>

                <div class="form-group">
                  <label [for]="'text_' + i" class="required">N·ªôi dung</label>
                  <textarea
                    [id]="'text_' + i"
                    [(ngModel)]="line.text"
                    placeholder="N·ªôi dung n√≥i..."
                    rows="2"
                    [disabled]="loading"
                  ></textarea>
                </div>

                <div class="form-group">
                  <label [for]="'pinyin_' + i">Pinyin</label>
                  <input
                    type="text"
                    [id]="'pinyin_' + i"
                    [(ngModel)]="line.pinyin"
                    placeholder="Pinyin..."
                    [disabled]="loading"
                  />
                </div>

                <div class="form-group">
                  <label [for]="'translation_' + i" class="required">D·ªãch nghƒ©a</label>
                  <input
                    type="text"
                    [id]="'translation_' + i"
                    [(ngModel)]="line.translation"
                    placeholder="B·∫£n d·ªãch..."
                    [disabled]="loading"
                  />
                </div>
              </div>
            </div>
            }

            <button
              type="button"
              class="btn btn-outline"
              (click)="addDialogueLine()"
              [disabled]="loading"
            >
              + Th√™m l∆∞·ª£t h·ªôi tho·∫°i
            </button>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
</div>
